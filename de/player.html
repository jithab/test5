<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Audio + JSON Subtitle Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        margin: 0;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        height: 100vh;
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }
      .word-block {
        padding-bottom: 1rem;
      }
      .subtitle {
        font-size: 1.2em;
        text-align: left;
        color: #333;
        padding: 0.1rem;
      }

      audio {
        width: 100%;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .controls {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
      }

      button {
        flex: 1;
        padding: 1rem;
        font-size: 1.2rem;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #0056b3;
      }

      #copyLink {
        font-size: 0.9rem;
        color: #007bff;
        text-align: center;
        display: block;
        margin-top: 0.5rem;
        text-decoration: none;
      }

      #copyLink:hover {
        text-decoration: underline;
      }

      #copyMsg {
        font-size: 1rem;
        color: green;
        text-align: center;
        margin-top: 0.5rem;
      }

      em {
        font-style: italic;
        color: #555;
      }

      .word-text {
        font-weight: bold;
        color: #333;
      }

      .word-pron,
      .word-mean {
        display: none;
        pointer-events: auto;
      }

      .word-pron.visible,
      .word-mean.visible {
        display: block;
      }

      .word-pron {
        color: #666;
        font-style: italic;
      }

      .word-mean {
        color: #444;
        margin-top: 0.2rem;
      }

      @media (max-width: 600px) {
        .subtitle {
          font-size: 1em;
        }

        button {
          font-size: 1rem;
          padding: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="subtitle" id="subtitleText">Subtitle will appear here</div>

    <audio id="audio" controls></audio>

    <div class="controls">
      <button id="prevBtn">Prev</button>
      <button id="nextBtn">Next</button>
    </div>

    <a id="copyLink" href="#">Copy</a>

    <div id="wordDisplay" class="subtitle"></div>

    <div id="copyMsg"></div>

    <script>
      let subtitles = [];
      let currentIndex = 0;
      let checkTimer = null;

      const audio = document.getElementById("audio");
      const subtitleText = document.getElementById("subtitleText");
      const wordDisplay = document.getElementById("wordDisplay");
      const copyMsg = document.getElementById("copyMsg");

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          audio: params.get("audio"),
          subtitle: params.get("subtitle"),
        };
      }

      async function loadSubtitleFile(url) {
        const response = await fetch(url);
        const data = await response.json();
        return data.map((entry) => ({
          start: entry.start,
          end: entry.end,
          sent: entry.sent,
          tran: entry.tran,
          words: entry.words || [],
        }));
      }

      function showSubtitle(index) {
        if (!subtitles.length) return;
        const sub = subtitles[index];

        subtitleText.innerHTML = `
        <strong>${sub.sent}</strong><br />
        <em>${sub.tran}</em>
      `;

        const words = sub.words || [];
        let wordHtml = "";
        words.forEach((w) => {
          if (!w.w) return;
          wordHtml += `
          <div class="word-block">
              <div class="word-text">${w.w}</div>
              <div class="word-pron">${w.p}</div>
            <div class="word-mean">${w.m || ""}</div>
          </div>
        `;
        });
        wordDisplay.innerHTML = wordHtml;

        clearInterval(checkTimer);
        audio.pause();

        const seekAndPlay = () => {
          try {
            audio.currentTime = sub.start;
            setTimeout(() => {
              audio.play().then(() => {
                checkTimer = setInterval(() => {
                  if (audio.currentTime >= sub.end) {
                    audio.pause();
                    clearInterval(checkTimer);
                  }
                }, 100);
              });
            }, 100);
          } catch (err) {
            console.error("Error seeking:", err.message);
          }
        };

        if (audio.readyState >= 1) {
          seekAndPlay();
        } else {
          audio.addEventListener("loadedmetadata", seekAndPlay, { once: true });
        }
      }

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentIndex > 0) currentIndex--;
        showSubtitle(currentIndex);
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentIndex < subtitles.length - 1) currentIndex++;
        showSubtitle(currentIndex);
      });

      document.getElementById("subtitleText").addEventListener("click", () => {
        if (!subtitles.length) return;
        const sub = subtitles[currentIndex];

        clearInterval(checkTimer);
        audio.pause();

        const playSegment = () => {
          try {
            audio.currentTime = sub.start;
            setTimeout(() => {
              audio.play().then(() => {
                checkTimer = setInterval(() => {
                  if (audio.currentTime >= sub.end) {
                    audio.pause();
                    clearInterval(checkTimer);
                  }
                }, 100);
              });
            }, 100);
          } catch (err) {
            console.error("Replay error:", err.message);
          }
        };

        if (audio.readyState >= 1) {
          playSegment();
        } else {
          audio.addEventListener("loadedmetadata", playSegment, { once: true });
        }
      });

      document
        .getElementById("copyLink")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          if (!subtitles.length) return;

          const german_text = subtitles[currentIndex].sent;
          const text = `
${german_text}

Translate the German text using this format:

**[German sentence]**  
[English translation]*  

---
**[German word]** [English meaning] [IPA without slash] 
→[grammar explanation if needed]  
---

(repeat for key vocabulary)
`;
          try {
            await navigator.clipboard.writeText(text);
            copyMsg.textContent = "✅ Copied to clipboard!";
            setTimeout(() => (copyMsg.textContent = ""), 3000);
          } catch (err) {
            copyMsg.textContent = "Failed to copy.";
          }
        });

      // Toggle visibility only on the clicked span
      document.getElementById("wordDisplay").addEventListener("click", (e) => {
        if (e.target.classList.contains("word-text")) {
          e.target
            .closest(".word-block")
            .querySelector(".word-mean")
            .classList.toggle("visible");
          e.target
            .closest(".word-block")
            .querySelector(".word-pron")
            .classList.toggle("visible");
        }
      });

      (async function init() {
        const { audio: audioFile, subtitle: subtitleFile } = getQueryParams();
        if (audioFile) {
          audio.src = audioFile;
        }
        if (subtitleFile) {
          try {
            subtitles = await loadSubtitleFile(subtitleFile);
            currentIndex = 0;
            // Optionally show the first subtitle
            // showSubtitle(currentIndex);
          } catch (err) {
            subtitleText.textContent = "⚠️ Failed to load subtitle file.";
          }
        }
      })();
    </script>
  </body>
</html>
