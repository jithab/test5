<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Subtitle Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
        user-select: none; /* Disable text selection */
      }

      #header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #ffffff;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
      }

      audio {
        width: calc(100% - 70px);
        max-width: 100%;
      }

      #toggleSpeed {
        font-size: 1em;
        padding: 6px 10px;
        margin-left: 10px;
        flex-shrink: 0;
        cursor: pointer;
      }

      .subtitle {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        user-select: none;
      }

      .subtitle:hover {
        background-color: #eee;
      }

      .german {
        font-weight: bold;
        font-size: 1.1em;
      }

      .active {
        background-color: #d0ebff;
      }

      @media (hover: none) {
        .subtitle:hover {
          background-color: inherit;
        }
      }
    </style>
  </head>
  <body>
    <div id="header">
      <audio id="audio" controls></audio>
      <button id="toggleSpeed">1.0x</button>
    </div>

    <div id="subtitles"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const jsonUrl = params.get("json");
      const audioUrl = params.get("audio");

      const audio = document.getElementById("audio");
      const toggleSpeedBtn = document.getElementById("toggleSpeed");
      const subtitleContainer = document.getElementById("subtitles");

      let subtitles = [];
      let pressTimer;
      let currentIndex = -1;
      let currentSpeed = 1.0;

      toggleSpeedBtn.addEventListener("click", () => {
        currentSpeed = currentSpeed === 1.0 ? 0.75 : 1.0;
        audio.playbackRate = currentSpeed;
        toggleSpeedBtn.textContent = `${currentSpeed.toFixed(1)}x`;
      });

      async function loadContent() {
        if (!jsonUrl || !audioUrl) {
          alert("Missing 'json' or 'audio' URL parameter.");
          return;
        }

        audio.src = audioUrl;

        const response = await fetch(jsonUrl);
        const data = await response.json();
        subtitles = data.lines;
        renderSubtitles();
      }

      function renderSubtitles() {
        subtitles.forEach((sub, index) => {
          const div = document.createElement("div");
          div.className = "subtitle";
          div.dataset.index = index;

          const germanDiv = document.createElement("div");
          germanDiv.className = "german";
          germanDiv.textContent = sub.de;

          const englishDiv = document.createElement("div");
          englishDiv.textContent = sub.en;

          div.appendChild(germanDiv);
          div.appendChild(englishDiv);

          div.addEventListener("click", () => handleSubtitleClick(index));

          // Long press to copy
          div.addEventListener("touchstart", () => {
            pressTimer = setTimeout(() => {
              copyToClipboard(`german: ${sub.de}`);
            }, 600);
          });
          div.addEventListener("touchend", () => clearTimeout(pressTimer));
          div.addEventListener("mousedown", () => {
            pressTimer = setTimeout(() => {
              copyToClipboard(`${sub.de}
*[English translation]*

Make each German word or phrase bold. Provide IPA in parentheses. Group articles, prepositions, and nouns together where appropriate.


[German phrase] [English meaning] (IPA)  
→ [Part of speech or grammatical function; include gender, case, number, tense, etc.; short explanation]


At the end, explain the overall grammar structure of the sentence: clause type, verb position, tense, case assignment (especially from prepositions), and word order. Avoid using section headings.`);
            }, 600);
          });
          div.addEventListener("mouseup", () => clearTimeout(pressTimer));
          div.addEventListener("mouseleave", () => clearTimeout(pressTimer));

          subtitleContainer.appendChild(div);
        });

        audio.addEventListener("timeupdate", highlightCurrentSubtitle);
      }

      function handleSubtitleClick(index) {
        const sub = subtitles[index];
        const currentTime = audio.currentTime;

        if (currentTime >= sub.start && currentTime <= sub.end) {
          audio.paused ? audio.play() : audio.pause();
        } else {
          audio.currentTime = sub.start;
          audio.play();
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).catch(() => alert("Copy failed"));
      }

      function highlightCurrentSubtitle() {
        const currentTime = audio.currentTime;
        let matchedIndex = -1;

        for (let i = 0; i < subtitles.length; i++) {
          const sub = subtitles[i];
          if (currentTime >= sub.start && currentTime <= sub.end) {
            matchedIndex = i;
            break;
          }
          if (currentTime >= sub.start) {
            matchedIndex = i; // fallback to previous
          }
        }

        if (matchedIndex !== currentIndex) {
          const prev = document.querySelector(".subtitle.active");
          if (prev) prev.classList.remove("active");

          const currentElem = document.querySelector(
            `.subtitle[data-index="${matchedIndex}"]`
          );
          if (currentElem) {
            currentElem.classList.add("active");

            if (!isFullyVisible(currentElem)) {
              scrollWithOffset(currentElem);
            }
          }

          currentIndex = matchedIndex;
        }
      }

      function isFullyVisible(el) {
        const rect = el.getBoundingClientRect();
        const headerHeight = document.getElementById("header").offsetHeight;
        const viewHeight =
          window.innerHeight || document.documentElement.clientHeight;

        return rect.top >= headerHeight && rect.bottom <= viewHeight;
      }

      function scrollWithOffset(el) {
        const headerHeight = document.getElementById("header").offsetHeight;
        const elTop = el.getBoundingClientRect().top + window.pageYOffset;
        window.scrollTo({ top: elTop - headerHeight, behavior: "smooth" });
      }

      loadContent();
    </script>
  </body>
</html>
